<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>사이트 자동 랜덤 방문 매크로</title>
</head>
<body>
    <div id="list-container">
        <form>
            <div>
                다음 방문까지 기본 시간 입력 (ms): 
                <input type="number" id="visitInterval" placeholder="기본 시간(ms)" value="6000">
            </div>
            <div>
                다음 방문까지 랜덤 추가 시간 범위 입력 (ms): 
                <input type="number" id="minRandom" placeholder="최소 ms" value="1000"> ~ 
                <input type="number" id="maxRandom" placeholder="최대 ms" value="9998">
            </div><br>
            <div>
                창 닫는 시간 입력 (ms): 
                <input type="number" id="closeInterval" placeholder="닫는 시간(ms)" value="3000">
            </div><br>
            <div>
                랜덤 방문 사이트 개수 입력:
                <input type="number" id="minCount" placeholder="최소 개수" value="1" min="1"> ~ 
                <input type="number" id="maxCount" placeholder="최대 개수" value="3" min="1">
            </div><br>
            <div id="box">
                <button type="button" onclick="loadFile()">메모장 추가</button>
                <input type="file" id="fileInput" style="display:none;" accept=".txt" onchange="handleFile(this)">
                <input type="button" value="직접 추가" onclick="add_textbox()"> ← 버튼을 누르고 방문할 사이트 주소를 입력하세요.<br>
            </div>
        </form>
        <div>
            <button id="start" class="click" type="button">매크로시작</button>
            <button id="stop" class="stop" type="button" style="display: none;">매크로 중지</button>
        </div>
    </div>
    <div id="log" style="white-space: pre-line"></div>

    <script type="text/javascript">
        const startButton = document.getElementById("start");
        const stopButton = document.querySelector(".stop");
        const log = document.getElementById("log");

        let allLinks = [];
        let cafes = [];
        let count = 0;
        let article = 1;
        let worker = null;

        const updateUI = (isRunning) => {
            startButton.style.display = isRunning ? "none" : "block";
            stopButton.style.display = isRunning ? "block" : "none";
            log.textContent = '';
        };

        function loadFile() {
            document.getElementById("fileInput").click();
        }

        function handleFile(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                const links = content.split('\n').map(line => line.trim()).filter(line => line.length > 0);

                const box = document.getElementById("box");
                links.forEach(link => {
                    const newP = document.createElement('p');
                    newP.innerHTML = `<input type='text' class='Address' value='${link}'> <input type='button' value='삭제' onclick='remove(this)'>`;
                    box.appendChild(newP);
                });

                input.value = "";
            };
            reader.readAsText(file);
        }

        const add_textbox = () => {
            const box = document.getElementById("box");
            const newP = document.createElement('p');
            newP.innerHTML = "<input type='text' class='Address'> <input type='button' value='삭제' onclick='remove(this)'>";
            box.appendChild(newP);
        };

        const remove = (obj) => {
            document.getElementById('box').removeChild(obj.parentNode);
        };

        const createWorkerScript = (minRandom, maxRandom, visitIntervalInput) => {
            return `
                let count = 0;
                let article = 1;
                const BASE_NEXT_TIME = ${visitIntervalInput};

                const autoVisit = () => {
                    let new_article = 1 + Math.floor(Math.random() * 100);
                    while (article === new_article) {
                        new_article = 1 + Math.floor(Math.random() * 100);
                    }
                    article = new_article;

                    const RANDOM_VISIT_VARIATION = Math.floor(Math.random() * (${maxRandom} - ${minRandom} + 1)) + ${minRandom};
                    const nextTime = BASE_NEXT_TIME + RANDOM_VISIT_VARIATION;

                    postMessage({ type: 'visit', article, nextTime, count: ++count });

                    setTimeout(autoVisit, nextTime);
                };

                self.onmessage = (event) => {
                    if (event.data.type === 'start') {
                        autoVisit();
                    } else if (event.data.type === 'stop') {
                        self.close();
                    }
                };
            `;
        };

        const startMacro = () => {
            if (!worker) {
                updateUI(true);
                cafes = [];
                count = 0;
                article = 1;
                allLinks = Array.from(document.getElementsByClassName('Address')).map(item => item.value);

                if (allLinks.length === 0) {
                    alert("방문할 링크가 없습니다. 사이트 주소를 하나 이상 입력해주세요!");
                    updateUI(false);
                    return;
                }

                // 다음 방문까지 기본시간 입력 및 창 닫는 시간 입력
                const visitIntervalInput = parseInt(document.getElementById('visitInterval').value);
                const closeIntervalInput = parseInt(document.getElementById('closeInterval').value);
                CLOSE_INTERVAL = closeIntervalInput;

                if (isNaN(visitIntervalInput) || (visitIntervalInput <= 0)) {
                    alert("⚠️ 다음 방문까지 기본시간을 올바르게 입력해주세요!");
                    updateUI(false);
                    return;
                }
                if (isNaN(closeIntervalInput) || (closeIntervalInput < 0)) {
                    alert("⚠️ 창 닫는 시간을 올바르게 입력해주세요!");
                    updateUI(false);
                    return;
                }

                // 랜덤 추가 시간 입력 및 체크
                const minRandom = parseInt(document.getElementById('minRandom').value) || 1000;
                const maxRandom = parseInt(document.getElementById('maxRandom').value) || 9998;

                if (minRandom > maxRandom) {
                    alert("⚠️ 최소 랜덤 시간이 최대보다 클 수 없습니다!");
                    updateUI(false);
                    return;
                }

                // 방문할 링크 개수 계산 및 랜덤 선택
                const minCount = parseInt(document.getElementById('minCount').value);
                const maxCount = parseInt(document.getElementById('maxCount').value);

                if (isNaN(minCount) || isNaN(maxCount)) {
                    alert("⚠️ 최소/최대 방문 개수를 숫자로 입력해주세요!");
                    updateUI(false);
                    return;
                }
                if (minCount > maxCount) {
                    alert("⚠️ 최소 방문 개수가 최대 방문 개수보다 클 수 없습니다!");
                    updateUI(false);
                    return;
                }
                if (maxCount < 1 || minCount < 1) {
                    alert("⚠️ 방문할 개수는 최소 1개 이상이어야 합니다!");
                    updateUI(false);
                    return;
                }
                if (minCount > allLinks.length || maxCount > allLinks.length) {
                    alert(`⚠️ 입력한 범위가 너무 큽니다. 현재 가능한 링크 개수는 ${allLinks.length}개입니다.`);
                    updateUI(false);
                    return;
                }

                try {
                    const workerScript = createWorkerScript(minRandom, maxRandom, visitIntervalInput);
                    const blob = new Blob([workerScript], { type: 'application/javascript' });
                    worker = new Worker(URL.createObjectURL(blob));

                    worker.onmessage = (event) => {
                        if (event.data.type === 'visit') {
                            const { article, nextTime, count } = event.data;
                            
                            const visitCount = Math.min(Math.floor(Math.random() * (maxCount - minCount + 1)) + minCount, allLinks.length);
                            const shuffled = [...allLinks].sort(() => Math.random() - 0.5);
                            const selectedLinks = shuffled.slice(0, visitCount);

                            let notice = `\n\n[${count}회차 방문] 선택된 ${visitCount}개 사이트:\n`;

                            selectedLinks.forEach((link, i) => {
                                notice += `${link} 방문 시간: ${new Date().toLocaleString()}\n`;

                                const newWin = window.open(link, `cafe${i}_${Date.now()}`);

                                const closeTimer = setTimeout(() => {
                                    if (newWin && !newWin.closed) newWin.close();
                                }, CLOSE_INTERVAL);

                                cafes.push({ window: newWin, timerId: closeTimer });
                            });

                            const now = new Date();
                            const nextVisit = new Date(now.getTime() + nextTime);
                            const totalSeconds = Math.floor(nextTime / 1000);
                            const hours = Math.floor(totalSeconds / 3600);
                            const minutes = Math.floor((totalSeconds % 3600) / 60);
                            const seconds = totalSeconds % 60;
                            notice += `\n다음 방문까지: ${hours}시간 ${minutes}분 ${seconds}초 (${nextVisit.toLocaleString()})\n`;
                            log.textContent = notice;
                        }
                    };

                    worker.postMessage({ type: 'start' });

                } catch (error) {
                    console.error("오류 발생:", error);
                    if (worker) worker.terminate();
                    updateUI(false);
                    worker = null;
                    alert("매크로 실행 중 오류가 발생하여 중지되었습니다.");
                }
            }
        };

        const stopMacro = () => {
            if (worker) {
                worker.postMessage({ type: 'stop' });
                worker = null;
                updateUI(false);
            }

            cafes.forEach((item) => {
                if (item?.timerId) clearTimeout(item.timerId);
                if (item?.window && !item.window.closed) item.window.close();
            });
            cafes = [];
        };

        startButton.addEventListener("click", startMacro);
        stopButton.addEventListener("click", stopMacro);
        window.addEventListener('beforeunload', stopMacro);
    </script>
</body>
</html>